version: 2.1

jobs:
  syntax-check:
    docker:
      - image: circleci/golang:1.15
    environment:
      SHELLCHECK: stable
    steps:
      - run:
          name: install taskfile
          command: >
            curl -fsSL --output - https://taskfile.dev/install.sh | sh -s -- -d -b ${HOME}/bin
      - run:
          name: install shellcheck
          command: >
            curl -fsSL --output - "https://github.com/koalaman/shellcheck/releases/download/${SHELLCHECK}/shellcheck-${SHELLCHECK}.$(uname -s | tr A-Z a-z).$(uname -m).tar.xz" |
            tar -xJvf - --strip=1 --show-transformed-names -C ${HOME}/bin shellcheck-${SHELLCHECK}/shellcheck;
            chmod 755 ${HOME}/bin/shellcheck
      - run:
          name: install reviewdog
          command: >
            curl -fsSL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b ${HOME}/bin
      - checkout
      - run:
          name: shellcheck
          command: >
            shellcheck --format=checkstyle ./qrcode-wrapper/*.sh |
            reviewdog
            -f="checkstyle"
            -name="shellcheck"
            -reporter="bitbucket-code-report"
            -filter-mode="nofilter"
            -fail-on-error="false"
            -level="warning"

workflows:
  check:
    jobs:
      - syntax-check
